<!doctype html>
<html lang="en">
<meta charset="UTF-8">
<title>nanomorph test</title>
<button id="button">Run</button>
<div id="root"></div>
<script>{
  const { indexOf } = Array.prototype

  function scanKeys(node) {
    const keys = {}
    for(const child of node.children) {
      keys[child.id] = child
    }
    return keys
  }

  function patch(nodeA, nodeB) {
    const keysA = scanKeys(nodeA)
    const keysB = scanKeys(nodeB)
    const childrenB = Array.from(nodeB.children)
    let childA = nodeA.firstElementChild
    let childB, nextA, i, j
    while(childA) {
      nextA = childA.nextElementSibling
      if(!keysB[childA.id]) {
        childA.remove()
      }
      childA = nextA
    }
    for(i = 0; i < childrenB.length; i++) {
      childB = childrenB[i]
      childA = keysA[childB.id]
      if(childA) {
        continue
      }
      nextA = nodeA.children[i]
      if(nextA) {
        nextA.before(childB)
      }
      else nodeA.append(childB)
    }
    for(i = 0; i < childrenB.length; i++) {
      childB = childrenB[i]
      childA = keysA[childB.id]
      if(!childA) {
        continue
      }
      j = indexOf.call(nodeA.children, childA)
      if(i === j) {
        continue
      }
      nextA = nodeA.children[i].nextElementSibling
      if(nextA === childA) {
        continue
      }
      if(nextA) {
        nextA.before(childA)
      }
      else nodeA.append(childA)
    }
  }

  function ul(props) {
    const node = document.createElement('ul')
    node.append(...props.children)
    delete props.children
    return Object.assign(node, props)
  }

  function li(props) {
    const node = document.createElement('li')
    return Object.assign(node, props)
  }

  const button = document.getElementById('button')
  const root = document.getElementById('root')
  const nodeA = ul({
    children : [
      li({ id : 'li1', textContent : 'First' }),
      li({ id : 'li2', textContent : 'Second' }),
      li({ id : 'li3', textContent : 'Third' }),
    ],
  })
  const nodeB = ul({
    children : [
      li({ id : 'li0', textContent : 'Zeroth' }),
      li({ id : 'li2', textContent : 'Second' }),
      li({ id : 'li1', textContent : 'First' }),
      li({ id : 'li3', textContent : 'Third' }),
      li({ id : 'li4', textContent : 'Fourth' }),
    ],
  })

  root.append(nodeA)
  button.onclick = () => patch(nodeA, nodeB)
}</script>
</html>
